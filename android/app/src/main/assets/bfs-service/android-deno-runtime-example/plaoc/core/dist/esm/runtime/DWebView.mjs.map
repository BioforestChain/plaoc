{"version":3,"file":"DWebView.mjs","sources":["../../../../../../../../../../../android-deno-runtime-example/plaoc/core/dist/esm/runtime/DWebView.mjs"],"sourcesContent":["import { callDeno, callDVebView } from \"../deno/android.fn.mjs\";\nimport { deno } from \"../deno/index.mjs\";\nimport { loopRustBuffer } from \"../deno/rust.op.mjs\";\nclass DWebView {\n  constructor(metaData) {\n    this.isWaitingData = 0;\n    this.pool = [];\n    this.hightWaterMark = 10;\n    this.entry = metaData.manifest.enter;\n    this.url = metaData.baseUrl;\n    this.initAppMetaData(metaData);\n    deno.createHeader();\n    this.waterOverflow();\n  }\n  async waterOverflow() {\n    do {\n      const data = await loopRustBuffer().next();\n      if (data.done || this.isWaitingData > this.hightWaterMark) {\n        continue;\n      }\n      console.log(\"waterOverflow====>\", data.value);\n      try {\n        const handler = JSON.parse(data.value);\n        if (Object.values(callDeno).includes(handler.function)) {\n          this.callKotlinFactory(handler);\n          continue;\n        }\n      } catch (e) {\n        if (this.isWaitingData !== 0) {\n          this.callDwebViewFactory(data.value);\n          continue;\n        }\n      }\n    } while (true);\n  }\n  handlerEvalJs(wb, data) {\n    if (this.isWaitingData > this.hightWaterMark)\n      return;\n    console.log(\"handlerEvalJs:\", this.isWaitingData, wb, data);\n    deno.callEvalJsStringFunction(callDeno.evalJsRuntime, `\"javascript:document.querySelector('${wb}').dispatchStringMessage('${data}')\"`);\n  }\n  initAppMetaData(metaData) {\n    if (Object.keys(metaData).length === 0)\n      return;\n    deno.callFunction(callDeno.initMetaData, `'${JSON.stringify(metaData)}'`);\n  }\n  activity() {\n    deno.callFunction(callDeno.openDWebView, `\"${new URL(this.entry, this.url).href}\"`);\n  }\n  callKotlinFactory(handler) {\n    deno.callFunction(handler.function, handler.data);\n    this.pool.push(handler.function);\n    if (this.isWaitingData >= Number.MAX_SAFE_INTEGER)\n      return;\n    this.isWaitingData++;\n  }\n  callDwebViewFactory(data) {\n    const handler = this.pool.shift();\n    if (handler && callDVebView[handler]) {\n      this.handlerEvalJs(callDVebView[handler], data);\n    }\n    if (this.isWaitingData === 0)\n      return;\n    this.isWaitingData--;\n  }\n}\nexport { DWebView };\n//# sourceMappingURL=DWebView.mjs.map\n"],"names":[],"mappings":";;;AAGA,MAAM,SAAS;AAAA,EACb,YAAY,UAAU;AACpB,SAAK,gBAAgB;AACrB,SAAK,OAAO;AACZ,SAAK,iBAAiB;AACtB,SAAK,QAAQ,SAAS,SAAS;AAC/B,SAAK,MAAM,SAAS;AACpB,SAAK,gBAAgB,QAAQ;AAC7B,SAAK,aAAY;AACjB,SAAK,cAAa;AAAA,EACnB;AAAA,EACD,MAAM,gBAAgB;AACpB,OAAG;AACD,YAAM,OAAO,MAAM,eAAgB,EAAC,KAAI;AACxC,UAAI,KAAK,QAAQ,KAAK,gBAAgB,KAAK,gBAAgB;AACzD;AAAA,MACD;AACD,cAAQ,IAAI,sBAAsB,KAAK,KAAK;AAC5C,UAAI;AACF,cAAM,UAAU,KAAK,MAAM,KAAK,KAAK;AACrC,YAAI,OAAO,OAAO,QAAQ,EAAE,SAAS,QAAQ,QAAQ,GAAG;AACtD,eAAK,kBAAkB,OAAO;AAC9B;AAAA,QACD;AAAA,MACF,SAAQ,GAAP;AACA,YAAI,KAAK,kBAAkB,GAAG;AAC5B,eAAK,oBAAoB,KAAK,KAAK;AACnC;AAAA,QACD;AAAA,MACF;AAAA,IACF,SAAQ;AAAA,EACV;AAAA,EACD,cAAc,IAAI,MAAM;AACtB,QAAI,KAAK,gBAAgB,KAAK;AAC5B;AACF,YAAQ,IAAI,kBAAkB,KAAK,eAAe,IAAI,IAAI;AAC1D,SAAK,yBAAyB,SAAS,eAAe,uCAAuC,+BAA+B,SAAS;AAAA,EACtI;AAAA,EACD,gBAAgB,UAAU;AACxB,QAAI,OAAO,KAAK,QAAQ,EAAE,WAAW;AACnC;AACF,SAAK,aAAa,SAAS,cAAc,IAAI,KAAK,UAAU,QAAQ,IAAI;AAAA,EACzE;AAAA,EACD,WAAW;AACT,SAAK,aAAa,SAAS,cAAc,IAAI,IAAI,IAAI,KAAK,OAAO,KAAK,GAAG,EAAE,OAAO;AAAA,EACnF;AAAA,EACD,kBAAkB,SAAS;AACzB,SAAK,aAAa,QAAQ,UAAU,QAAQ,IAAI;AAChD,SAAK,KAAK,KAAK,QAAQ,QAAQ;AAC/B,QAAI,KAAK,iBAAiB,OAAO;AAC/B;AACF,SAAK;AAAA,EACN;AAAA,EACD,oBAAoB,MAAM;AACxB,UAAM,UAAU,KAAK,KAAK,MAAK;AAC/B,QAAI,WAAW,aAAa,UAAU;AACpC,WAAK,cAAc,aAAa,UAAU,IAAI;AAAA,IAC/C;AACD,QAAI,KAAK,kBAAkB;AACzB;AACF,SAAK;AAAA,EACN;AACH;;"}